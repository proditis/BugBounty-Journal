# Attempt to grab the certificates including chain from the given domain.list
# At the end convert each cert to text format
certgrabber:
  image: debian:bullseye-slim
  stage: information_gathering
  before_script:
    - apt-get update
    - apt-get install --no-install-recommends -yqq wget unzip openssl
    - wget --no-check-certificate https://github.com/stavinski/certgrabber/releases/download/v1.0.4/certgrabber_1.0.4_Linux_x86_64
    - chmod +x certgrabber_1.0.4_Linux_x86_64
    - mkdir -p certs
  script:
    - for FQDN in $(<domain.list);do ./certgrabber_1.0.4_Linux_x86_64 -c -o certs/${FQDN}.x509 ${FQDN}:443 ;done || true
    - for _cert in certs/*.x509;do openssl x509 -in ${_cert} -text > ${_cert}.txt ;done
  artifacts:
    name: "$DOMAIN:$CI_JOB_NAME:certs"
    paths:
      - certs/*
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
